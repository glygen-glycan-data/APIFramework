<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Motif Match</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body>
<div id="basic">
    <p id="time"></p>
    <p id="server-status"></p>
</div>
<div id="compute">
    <textarea rows = "40" id="sequence" style="width: 100%; max-width: 100%">WURCS=2.0/4,7,6/[u2122h_2*NCC/3=O][a2122h-1b_1-5_2*NCC/3=O][a1122h-1b_1-5][a1122h-1a_1-5]/1-2-3-4-4-4-4/a4-b1_b4-c1_c3-d1_c6-e1_e3-f1_e6-g1</textarea><br>
    <form id="collection">
        <input type="radio" name="collection" value="GM" checked>All motifs
        <input type="radio" name="collection" value="GGM">GlyGen
        <input type="radio" name="collection" value="CCRC">CCRC
        <input type="radio" name="collection" value="GD">Glydin
        <input type="radio" name="collection" value="GDB">Glydin - BiOligo
        <input type="radio" name="collection" value="GDC">Glydin - Cummings
        <input type="radio" name="collection" value="GDH">Glydin - Hayes
        <input type="radio" name="collection" value="GDSB">Glydin - SugarBind
        <input type="radio" name="collection" value="GDV">Glydin - Cermav
        <input type="radio" name="collection" value="GE">GlycoEpitope Epitopes
        <input type="radio" name="collection" value="GTC">GlyTouCan
        <input type="radio" name="collection" value="UCM">UniCarbKB
    </form>
    <button id="submit-sequence" onclick="compute()">Submit</button>
    <br><br><br>
    <div id="result"></div>
</div>
<script>

    function updateServerStatus(){
        jQuery.getJSON("./queue").then(function (d) {
            const s_p = " motifs are waiting for aligning";
            var s_s = "1 motif is waiting for aligning";
            var s_empty = "Empty load on the server";
            var s = "";

            if (d == 0) {
                s = s_empty;
            }
            else if (d == 1) {
                s = s_s;
            }
            else {
                s = d + s_p;
            }
            document.getElementById("server-status").innerHTML = s;
        })
    }
    // updateServerStatus();

    function space(){
        var space = document.createElement("span");
        space.innerHTML = '&nbsp&nbsp';
        return space
    }

    var list_id = "";
    var query_counter = 0;
    var this_result = {};
    function compute(){
        var para = {};

        var collection = "GM";
        var radios = document.getElementById("collection");
        for (var radio of radios.getElementsByTagName("input")){

            if (radio.name != "collection"){
                continue
            }
            if( radio.checked){
                collection = radio.value;
            }
        }
        para["seq"] = document.getElementById("sequence").value;
        para["collection"] = collection;

        var requestURL = "./submit?tasks="+encodeURIComponent(JSON.stringify([para]));

        jQuery.getJSON(requestURL).then(function (d) {
            d = d[0]
            list_id = d.id;
            query_counter = 0;
            //document.getElementById("result").innerHTML = "<a href='./retrieve?list_id="+d.list_id+"'>"+"Click me to see result"+"</a>";
            document.getElementById("result").innerHTML = "Submitted successfully";
            get_results();
        })
    }

    function get_results() {
        var requestURL = "./retrieve?list_ids=" + JSON.stringify([list_id]);
        query_counter += 1;
        jQuery.getJSON(requestURL).then(function (d) {
            d = d[0];
            if (d.finished){
                this_result = d;
                display_results();
            }else{
                setTimeout(get_results, 1000);
                document.getElementById("result").innerHTML = "Checked for the "+query_counter+" times, haven't completed yet";
            }
        })
    }

    function display_results() {
        var d = this_result;

        var runtime = d["stat"]["runtime"];
        var matches = d["result"];
        var rterror = d["error"];

        if (rterror.length > 0){
            document.getElementById("result").innerHTML = "ERROR: "+rterror;
            return
        }

        document.getElementById("result").innerHTML = "Alignment Calculation Time: " + runtime.toFixed(5) + "s<br> Matched glycan count: " + matches.length + "<br>";

        var tableEle = document.createElement("table");
        tableEle.style = "width: 100%; text_align: center;";
        tableEle.innerHTML = "<tr><th>GlycoMotif</th><th>GlyTouCan</th><th>Name</th><th>Alignment Type</th><th>Strict</th></tr>";

        var tableRows = {};

        for (var match of matches){
            //[collection, pageacc, acc, name, "Non-Reducing", nred_strict]
            var collection = match[0];
            var pageacc = match[1];
            var gtcacc = match[2];
            var name = match[3];
            var alignment_type = match[4];
            var strict = match[5];

            var strict_str = ""
            if (strict){
                strict_str = "Y"
            }
            //"+collection+"."+pageacc+"

            var key = collection+"."+pageacc ;
            var ele = document.createElement("tr");
            ele.innerHTML =
                "<tr>" +
                "<td><a href='https://glycomotif.glyomics.org/glycomotifdev/"+collection+"."+pageacc+"'>"+collection+"."+pageacc+"</a></td>" +
                "<td><a href='https://glytoucan.org/Structures/Glycans/"+gtcacc+"'>"+gtcacc+"</a></td>" +
                "<td><img src='https://image.glycosmos.org/snfg/png/"+gtcacc+"'><br>"+name+"</td>" +
                "<td>"+alignment_type+"</td>" +
                "<td>"+strict_str+"</td>" +
                "</tr>";

            tableRows[key] = ele;


        }

        for (var k of Object.keys(tableRows)){
            var rowEle = tableRows[k];
            rowEle.style.textAlign = "center";
            tableEle.appendChild(rowEle);
        }


        document.getElementById("result").appendChild(tableEle);

    }





</script>
</body>
</html>